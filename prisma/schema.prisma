generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["nativeTypes"]
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model activity_logs {
  id          BigInt    @id @default(autoincrement())
  user_id     BigInt?
  action      String?   @db.VarChar(255)
  target_type String?   @db.VarChar(50)
  target_id   BigInt?
  metadata    Json?     @db.Json
  options     String?
  created_at  DateTime? @default(now()) @db.Timestamp(6)
  users       users?    @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model companies {
  id                 BigInt               @id @default(autoincrement())
  name               String               @db.VarChar(255)
  description        String?
  contact_email      String?              @db.VarChar(255)
  created_at         DateTime?            @default(now()) @db.Timestamp(6)
  updated_at         DateTime?            @default(now()) @db.Timestamp(6)
  status             Boolean              @default(true)
  deletedAt          DateTime?
  cleaner_review     cleaner_review[]     @relation("CompanyReviews")
  location_types     location_types[]
  locations          locations[]
  registered_users   registered_users[]
  users              users[]
  facility_companies facility_companies[]
  shifts             shifts[]
}

model hygiene_scores {
  id           BigInt     @id @default(autoincrement())
  location_id  BigInt?
  score        Decimal?   @db.Decimal(5, 2)
  details      Json?      @db.Json
  image_url    String?    @db.VarChar(255)
  inspected_at DateTime   @db.Timestamp(6)
  created_by   BigInt?
  created_at   DateTime?  @default(now()) @db.Timestamp(6)
  users        users?     @relation(fields: [created_by], references: [id], onDelete: NoAction, onUpdate: NoAction)
  locations    locations? @relation(fields: [location_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model locations {
  id                     BigInt                   @id @default(autoincrement())
  name                   String                   @db.VarChar(255)
  parent_id              BigInt?
  company_id             BigInt?
  latitude               Float?
  longitude              Float?
  metadata               Json?                    @db.Json
  created_at             DateTime?                @default(now()) @db.Timestamp(6)
  updated_at             DateTime?                @default(now()) @db.Timestamp(6)
  type_id                BigInt?
  options                Json?                    @default("{}")
  lang_preference        String?                  @db.VarChar(255)
  state                  String?
  geom                   Unsupported("geometry")?
  images                 String[]
  deletedAt              DateTime?
  address                String?
  pincode                String?
  average_cleaning_score Float?
  city                   String?
  current_cleaning_score Float?
  dist                   String?
  status                 Boolean?
  user_review_score      Float?
  no_of_photos           Int?
  cleaner_assignments    cleaner_assignments[]
  cleaner_reviews        cleaner_review[]         @relation("LocationReviews")
  hygiene_scores         hygiene_scores[]
  companies              companies?               @relation(fields: [company_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  locations              locations?               @relation("locationsTolocations", fields: [parent_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  other_locations        locations[]              @relation("locationsTolocations")
  location_types         location_types?          @relation(fields: [type_id], references: [id], onDelete: SetNull, onUpdate: NoAction)
  facility_companies     facility_companies?      @relation(fields: [facility_companiesId], references: [id])
  facility_companiesId   BigInt?

  @@index([geom], map: "idx_locations_geom", type: Gist)
}

model location_types {
  id                   BigInt           @id @default(autoincrement())
  name                 String           @db.VarChar(100)
  parent_id            BigInt?
  company_id           BigInt?
  sort_order           Int?
  created_at           DateTime?        @default(now()) @db.Timestamp(6)
  updated_at           DateTime?        @default(now()) @db.Timestamp(6)
  is_toilet            Boolean?
  deletedAt            DateTime?
  companies            companies?       @relation(fields: [company_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  location_types       location_types?  @relation("location_typesTolocation_types", fields: [parent_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  other_location_types location_types[] @relation("location_typesTolocation_types")
  locations            locations[]
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model review {
  id            BigInt          @id @default(autoincrement())
  user_id       BigInt
  site_id       Int
  rating        Int?
  comment       String?
  image_urls    String[]
  created_at    DateTime?       @default(now()) @db.Timestamp(6)
  updated_at    DateTime?       @default(now()) @db.Timestamp(6)
  review_photos review_photos[]
}

model review_photos {
  id         BigInt    @id
  user_id    BigInt?
  image_url  String?   @db.VarChar(255)
  created_at DateTime? @default(now()) @db.Timestamp(6)
  review     review?   @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model sessions {
  id         BigInt    @id @default(autoincrement())
  user_id    BigInt?
  token      String?   @unique @db.VarChar(255)
  expires_at DateTime? @db.Timestamp(6)
  created_at DateTime? @default(now()) @db.Timestamp(6)
  users      users?    @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model users {
  id                                BigInt                @id @default(autoincrement())
  name                              String                @db.VarChar(255)
  email                             String?               @db.VarChar(255)
  password                          String
  company_id                        BigInt?
  created_at                        DateTime?             @default(now()) @db.Timestamp(6)
  updated_at                        DateTime?             @default(now()) @db.Timestamp(6)
  phone                             String?               @unique(map: "unique_phone") @db.VarChar(15)
  age                               Int?
  birthdate                         DateTime?             @db.Date
  role_id                           Int?
  deletedAt                         DateTime?
  token                             String?               @db.VarChar(255)
  activity_logs                     activity_logs[]
  cleaner_assignments_as_cleaner    cleaner_assignments[] @relation("CleanerUser")
  cleaner_assignments_as_supervisor cleaner_assignments[] @relation("Supervisor")
  cleaner_reviews                   cleaner_review[]      @relation("CleanerReviews")
  hygiene_scores                    hygiene_scores[]
  sessions                          sessions[]
  companies                         companies?            @relation(fields: [company_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  role                              Role?                 @relation(fields: [role_id], references: [id])
  shift_assignments                 shift_assignments[]
}

model configurations {
  id          BigInt   @id @default(autoincrement())
  name        String   @unique @db.VarChar(255)
  description Json?
  company_id  BigInt?
  is_active   Boolean  @default(false)
  notes       String?
  created_at  DateTime @default(now()) @db.Timestamptz(6)
  updated_at  DateTime @default(now()) @db.Timestamptz(6)
}

model cleaner_review {
  id              BigInt     @id @default(autoincrement())
  name            String
  latitude        Float?
  longitude       Float?
  address         String?
  created_at      DateTime?  @default(now()) @db.Timestamptz(6)
  updated_at      DateTime?  @default(now()) @db.Timestamptz(6)
  location_id     BigInt?
  cleaner_user_id BigInt?
  tasks           String[]
  initial_comment String?
  final_comment   String?
  before_photo    String[]
  after_photo     String[]
  status          String     @default("ongoing")
  company_id      BigInt?
  score           Float?
  cleaner_user    users?     @relation("CleanerReviews", fields: [cleaner_user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  company         companies? @relation("CompanyReviews", fields: [company_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  location        locations? @relation("LocationReviews", fields: [location_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model user_review {
  id          BigInt    @id @default(autoincrement())
  toilet_id   BigInt?
  name        String?   @db.VarChar(100)
  email       String?   @db.VarChar(100)
  phone       String?   @db.VarChar(20)
  rating      Float?
  description String?
  reason_ids  Int[]
  images      String[]
  created_at  DateTime? @default(now()) @db.Timestamptz(6)
  updated_at  DateTime? @default(now()) @db.Timestamptz(6)
  longitude   Float?
  latitude    Float?
  ai_score    Float?
  company_id  BigInt?
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model spatial_ref_sys {
  srid      Int     @id
  auth_name String? @db.VarChar(256)
  auth_srid Int?
  srtext    String? @db.VarChar(2048)
  proj4text String? @db.VarChar(2048)
}

model cleaner_assignments {
  id              BigInt    @id @default(autoincrement())
  name            String    @db.VarChar(255)
  cleaner_user_id BigInt
  company_id      BigInt
  type_id         BigInt?
  location_id     BigInt?
  status          String?   @default("unassigned") @db.VarChar(50)
  assigned_on     DateTime? @default(now()) @db.Timestamp(6)
  released_on     DateTime? @db.Timestamp(6)
  created_at      DateTime? @default(now()) @db.Timestamp(6)
  updated_at      DateTime? @default(now()) @db.Timestamp(6)
  supervisor_id   BigInt?
  role_id         Int?
  deletedAt       DateTime?

  cleaner_user users      @relation("CleanerUser", fields: [cleaner_user_id], references: [id])
  supervisor   users?     @relation("Supervisor", fields: [supervisor_id], references: [id])
  locations    locations? @relation(fields: [location_id], references: [id], onDelete: Cascade, map: "fk_assignments_location")

  role Role? @relation(fields: [role_id], references: [id])
}

model Role {
  id                  Int                   @id @default(autoincrement())
  name                String                @unique @db.VarChar(50)
  description         String?
  permissions         String[]              @default([])
  is_active           Boolean               @default(true)
  created_at          DateTime?             @default(now())
  updated_at          DateTime?             @updatedAt
  registered_users    registered_users[]
  users               users[]
  cleaner_assignments cleaner_assignments[]
  shiftAssignments    shift_assignments[]
}

model registered_users {
  id                 BigInt    @id @default(autoincrement())
  company_id         BigInt
  name               String    @db.VarChar(255)
  phone              String    @unique @db.VarChar(15)
  role_id            Int
  temporary_password String?   @db.VarChar(255)
  is_verified        Boolean   @default(false)
  verification_token String?   @unique @db.VarChar(255)
  created_at         DateTime  @default(now()) @db.Timestamp(6)
  updated_at         DateTime  @default(now()) @db.Timestamp(6)
  companies          companies @relation(fields: [company_id], references: [id], onDelete: Cascade)
  role               Role      @relation(fields: [role_id], references: [id])
}

model facility_companies {
  id BigInt @id @default(autoincrement())

  // Basic Information
  name  String  @db.VarChar(255)
  email String? @db.VarChar(255)
  phone String  @unique @db.VarChar(20)

  // Contact Person Details
  contact_person_name  String  @db.VarChar(255)
  contact_person_phone String? @db.VarChar(20)
  contact_person_email String? @db.VarChar(255)

  // Address
  address String? @db.Text
  city    String? @db.VarChar(100)
  state   String? @db.VarChar(100)
  pincode String? @db.VarChar(10)
  country String? @default("India") @db.VarChar(100)

  // Business/Legal
  registration_number String?   @unique @db.VarChar(100) // GST/Business registration
  pan_number          String?   @db.VarChar(20)
  license_number      String?   @db.VarChar(100)
  license_expiry_date DateTime? @db.Date

  // Contract Details
  contract_start_date DateTime? @db.Date
  contract_end_date   DateTime? @db.Date

  // Performance Metrics
  rating                  Float? @default(0)
  total_locations_managed Int    @default(0)
  active_locations        Int    @default(0)

  // Status & Verification
  status Boolean @default(true) // Active/Inactive

  // Additional Info
  description String? @db.Text

  // Audit Fields
  company_id BigInt
  created_at DateTime  @default(now()) @db.Timestamp(6)
  updated_at DateTime  @updatedAt @db.Timestamp(6)
  deletedAt  DateTime?

  // Relations
  company   companies   @relation(fields: [company_id], references: [id], onDelete: Cascade)
  locations locations[]
}

model shifts {
  id BigInt @id @default(autoincrement())

  // Basic Info
  name        String? @db.VarChar(255)
  description String? @db.Text
  status      Boolean @default(true) // active, inactive, archived

  // Time Fields
  startTime     DateTime? @db.Time
  endTime       DateTime? @db.Time
  durationHours Float?

  // Validity
  effectiveFrom  DateTime? @default(now())
  effectiveUntil DateTime?

  // Audit Fields
  createdAt DateTime? @default(now()) @db.Timestamp(6)
  updatedAt DateTime? @updatedAt @db.Timestamp(6)
  deletedAt DateTime?

  // Relations - Company Specific
  company_id BigInt?
  company    companies? @relation(fields: [company_id], references: [id], onDelete: Cascade)

  // Users assigned to this shift
  assignments shift_assignments[]
}

// âœ… Bridge Table - Tracks shift assignments over time
model shift_assignments {
  id BigInt @id @default(autoincrement())

  // Relations
  shiftId BigInt
  shift   shifts @relation(fields: [shiftId], references: [id], onDelete: Cascade)

  user_id BigInt
  user    users  @relation(fields: [user_id], references: [id], onDelete: Cascade)
  role_id Int?

  // Assignment Period
  startDate DateTime // When assignment starts
  endDate   DateTime? // When assignment ends (null = ongoing)
  status    String    @default("active") @db.VarChar(50) // active, inactive, completed, paused

  notes String? @db.Text
  role  Role?   @relation(fields: [role_id], references: [id])

  // Audit Fields
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
}
